#!/usr/local/bin/zsh

if which ansifilter > /dev/null 2>&1; then
else
  PWD=`pwd`
  curl http://www.andre-simon.de/zip/ansifilter-2.1.tar.bz --output /tmp/ansifilter-2.1.tar.bz2
  tar -jxvf /tmp/ansifilter-2.1.tar.bz2 -C /tmp/
  cd /tmp/ansifilter-2.1
  make
  mv src/ansifilter /usr/local/bin/ansifilter
  cd ${PWD}
fi

if [[ $TERM = screen ]] || [[ $TERM = screen-256color ]] ; then
  local LOGDIR=$HOME/Documents/term_logs
  local LOGFILE=$(date +${@}_%Y-%m-%d_%H-%M-%S.log)
  local FILECOUNT=0
  local MAXFILECOUNT=200
  # 本スクリプト起動時に自動で$MAXFILECOUNTのファイル数以上ログファイルあれば消す
  for file in `\find "$LOGDIR" -maxdepth 1 -type f -name "*.log" | sort --reverse`; do
    FILECOUNT=`expr $FILECOUNT + 1`
    if [ $FILECOUNT -ge $MAXFILECOUNT ]; then
      rm -f $file
    fi
  done
  [ ! -d $LOGDIR ] && mkdir -p $LOGDIR
  tmux  set-option default-terminal "screen" \; \
  pipe-pane        "cat - | ansifilter | ~/.zsh_timestamp >> $LOGDIR/$LOGFILE" \; \
  display-message  "💾Started logging to $LOGDIR/$LOGFILE"
  env LANG=C ssh -o StrictHostKeyChecking=no $@
  tmux pipe-pane\; display-message  "🔔End logging to $LOGDIR/$LOGFILE"
fi
